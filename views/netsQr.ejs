<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/event-source-polyfill"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .qr-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        .qr-header h1 {
            color: #333;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .qr-code-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #e9ecef;
        }
        .qr-code-box img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .amount-display {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
        }
        .timer-section {
            background: #fff3cd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        #timer {
            font-size: 24px;
            font-weight: 700;
            color: #856404;
        }
        .instructions {
            background: #d1ecf1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
            text-align: left;
        }
        .instructions h5 {
            color: #0c5460;
            margin-bottom: 10px;
        }
        .instructions ol {
            color: #0c5460;
            margin: 0;
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="qr-container">
        <div class="qr-header">
            <h1><i class="fas fa-qrcode"></i> NETS QR Payment</h1>
            <p class="text-muted">Scan with your bank app to complete payment</p>
        </div>

        <div class="amount-display">$<%= total.toFixed(2) %></div>

        <div class="qr-code-box">
            <img src="<%= qrCodeUrl %>" alt="NETS QR Code" />
        </div>

        <div class="instructions">
            <h5><i class="fas fa-info-circle"></i> How to pay:</h5>
            <ol>
                <li>Open your bank's mobile app</li>
                <li>Select "Scan QR Code"</li>
                <li>Point at the QR code above</li>
                <li>Complete the payment</li>
            </ol>
        </div>

        <div class="timer-section">
            <small class="text-uppercase">⏱️ Time Remaining</small>
            <div id="timer">5:00</div>
        </div>

        <a href="/cart/checkout" class="btn btn-outline-secondary mt-3">
            <i class="fas fa-times"></i> Cancel Payment
        </a>
    </div>

    <script>
        let s2sNetsTxnStatus;

        const txnRetrievalRef = "<%= txnRetrievalRef %>";
        const apiKey = "<%= apiKey %>";
        const projectId = "<%= projectId %>";
        const url = `/sse/payment-status/${txnRetrievalRef}`;

        console.log("Starting NETS payment polling for:", txnRetrievalRef);

        // Initialize EventSource for real-time polling
        s2sNetsTxnStatus = new EventSourcePolyfill(url, {
            headers: {
                "api-key": apiKey,
                "project-id": projectId,
            },
            heartbeatTimeout: 150000,
        });

        s2sNetsTxnStatus.addEventListener("message", (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log("NETS Payment Status Update:", data);

                // Check for payment success
                if (data.success) {
                    console.log("✓ Payment successful!");
                    if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
                    window.location.href = `/nets-qr/success?txn_retrieval_ref=${txnRetrievalRef}`;
                } 
                // Check for payment failure
                else if (data.fail) {
                    console.log("✗ Payment failed!");
                    if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
                    window.location.href = `/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`;
                }
                // Still waiting for payment
                else {
                    console.log("Payment still pending...");
                }
            } catch (err) {
                console.error("Error parsing payment status:", err);
            }
        });

        s2sNetsTxnStatus.addEventListener("error", (event) => {
            console.error("EventSource error:", event);
            if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
            window.location.href = `/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`;
        });

        // Countdown Timer Logic
        const timerElement = document.getElementById("timer");
        const countdownDuration = 300; // 5 minutes
        let remainingTime = countdownDuration;

        const updateTimer = () => {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
            remainingTime--;

            if (remainingTime < 0) {
                clearInterval(timerInterval);
                timerElement.textContent = "Timed out";
                timerElement.parentElement.classList.add('bg-danger', 'text-white');

                if (s2sNetsTxnStatus) {
                    s2sNetsTxnStatus.close();
                }
                setTimeout(() => {
                    window.location.href = `/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`;
                }, 2000);
            }
        };

        // Start the timer
        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer();

        console.log("NETS QR Payment page loaded successfully");
    </script>
</body>
</html>
            color: #667eea;
            font-weight: 500;
            margin: 15px 0;
            font-size: 14px;
        }
        .instruction-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #0c5460;
            font-size: 14px;
            text-align: left;
        }
        .instruction-box strong {
            display: block;
            margin-bottom: 10px;
        }
        .btn-cancel {
            background-color: #e9ecef;
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .btn-cancel:hover {
            background-color: #dee2e6;
            color: #333;
        }
        .spinner-section {
            display: none;
            margin: 20px 0;
        }
        .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="qr-container">
        <div class="qr-header">
            <h1><i class="fas fa-qrcode"></i> NETS QR Payment</h1>
            <p>Scan with your bank app to complete payment</p>
        </div>

        <div class="amount-display">
            $<%= total %>
        </div>

        <div class="qr-code-box">
            <img src="<%= qrCodeUrl %>" alt="NETS QR Code" id="qrCodeImage">
        </div>

        <div class="instruction-box">
            <strong>How to pay:</strong>
            <ol style="margin: 0; padding-left: 20px;">
                <li>Open your bank's mobile app</li>
                <li>Select "Scan QR Code"</li>
                <li>Point at the QR code above</li>
                <li>Complete the payment</li>
            </ol>
        </div>

        <div class="timer-section">
            <div class="timer-label">
                <i class="fas fa-clock"></i> Time Remaining
            </div>
            <div id="timer">5:00</div>
        </div>

        <div class="status-message" id="statusMessage">
            <i class="fas fa-spinner fa-spin"></i> Waiting for payment...
        </div>

        <div class="spinner-section" id="spinnerSection">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p style="margin-top: 10px; color: #667eea;">Processing your payment...</p>
        </div>

        <a href="/cart" class="btn-cancel">
            <i class="fas fa-arrow-left"></i> Back to Cart
        </a>
    </div>

    <script>
        const txnRetrievalRef = "<%= txnRetrievalRef %>";
        const cartTotal = <%= total %>;
        let pollCount = 0;
        const maxPolls = 60;
        let s2sNetsTxnStatus = null;

        // Timer countdown
        const timerElement = document.getElementById('timer');
        const countdownDuration = 300;
        let remainingTime = countdownDuration;

        const updateTimer = () => {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            remainingTime--;

            if (remainingTime < 0) {
                clearInterval(timerInterval);
                timerElement.textContent = 'Time expired';
                if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
                document.getElementById('statusMessage').innerHTML = '<i class="fas fa-times-circle"></i> Transaction timed out';
                setTimeout(() => window.location.href = '/cart', 2000);
            }
        };

        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer();

        // SSE connection for payment status
        const url = `/api/nets/payment-status/${txnRetrievalRef}`;

        if (s2sNetsTxnStatus) {
            s2sNetsTxnStatus.close();
        }

        s2sNetsTxnStatus = new EventSourcePolyfill(url, {
            heartbeatTimeout: 150000,
        });

        s2sNetsTxnStatus.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            console.log('NETS Query Response:', data);

            if (data.success || (data.result?.data?.response_code === '00' && data.result?.data?.txn_status === 1)) {
                clearInterval(timerInterval);
                if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
                document.getElementById('statusMessage').innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Payment successful!';
                document.getElementById('spinnerSection').style.display = 'block';
                setTimeout(() => window.location.href = '/orders', 2000);
            } else if (data.fail || (data.result?.data?.response_code !== '00' || data.result?.data?.txn_status === 2)) {
                clearInterval(timerInterval);
                if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
                document.getElementById('statusMessage').innerHTML = '<i class="fas fa-times-circle" style="color: #dc3545;"></i> Payment failed. Please try again.';
                setTimeout(() => window.location.href = '/cart', 3000);
            }
        });

        s2sNetsTxnStatus.onerror = (error) => {
            console.error('EventSource error:', error);
            clearInterval(timerInterval);
            if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
            document.getElementById('statusMessage').innerHTML = '<i class="fas fa-exclamation-circle" style="color: #dc3545;"></i> Connection error. Please try again.';
        };

        console.log('NETS QR Payment initialized for transaction:', txnRetrievalRef);
    </script>
</body>
</html>
