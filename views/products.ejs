<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<%- include('partials/navbar', { user: user }) %>
<main class="container my-5">
  <div class="row">
    <div class="col-12">
      <h3 class="mb-4">Products from Supermarket</h3>
      <% if (success) { %><div class="alert alert-success"><%= success %></div><% } %>
      <% if (error) { %><div class="alert alert-danger"><%= error %></div><% } %>
      <form method="GET" action="/products" class="row mb-3 g-2 align-items-center">
        <div class="col-auto">
          <input type="text" name="search" class="form-control" placeholder="Search products..." value="<%= typeof search !== 'undefined' ? search : '' %>">
        </div>
        <div class="col-auto">
          <select name="category" class="form-select">
            <% (categories || []).forEach(function(c) { %>
              <option value="<%= c %>" <%= (typeof activeCategory !== 'undefined' && activeCategory === c) ? 'selected' : '' %>><%= c %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-outline-primary">Filter</button>
        </div>
      </form>

      <div class="row g-4">
        <% products.forEach(function(p) { %>
          <div class="col-md-4">
            <div class="card h-100 shadow-sm">
              <% if (p.image) { %>
                <img src="/images/<%= p.image %>" class="card-img-top" alt="<%= p.productName %>" style="object-fit:cover; height:180px;">
              <% } %>
              <div class="card-body">
                <h5 class="card-title"><%= p.productName %></h5>
                <p class="card-text mb-2">$<%= Number(p.price).toFixed(2) %></p>
                <p class="text-muted small">Stock: <%= Number(p.quantity) %></p>
                <% if (Number(p.quantity) > 0) { %>
                <form method="POST" action="/products/buy" class="d-flex align-items-center gap-2">
                  <input type="hidden" name="productId" value="<%= p.id %>">
                  <input type="number" name="quantity" min="1" value="1" class="form-control" style="width:80px;">
                  <button type="submit" class="btn btn-primary btn-sm">Buy</button>
                </form>
                <% } else { %>
                  <button class="btn btn-secondary btn-sm" disabled>Out of stock</button>
                <% } %>
                <% if (user && user.role === "admin") { %>
                  <a href="/products/edit/<%= p.id %>" class="btn btn-warning btn-sm mt-2 me-2">Edit</a>
                  <form method="POST" action="/products/delete/<%= p.id %>" style="display:inline">
                    <button type="submit" class="btn btn-danger btn-sm mt-2">Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
